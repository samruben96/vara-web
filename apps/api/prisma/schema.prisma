// Vara - Digital Safety Platform for Women
// Prisma Schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector]
}

// ============================================================================
// User & Profile
// ============================================================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  profile             UserProfile?
  onboardingResponses OnboardingResponse[]
  connectedAccounts   ConnectedAccount[]
  protectedImages     ProtectedImage[]
  alerts              Alert[]
  protectionPlan      ProtectionPlan?
  scanJobs            ScanJob[]

  @@map("users")
}

model UserProfile {
  id                  String    @id @default(uuid())
  userId              String    @unique
  displayName         String?
  riskLevel           RiskLevel @default(LOW)
  onboardingCompleted Boolean   @default(false)
  createdAt           DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ============================================================================
// Onboarding
// ============================================================================

model OnboardingResponse {
  id         String   @id @default(uuid())
  userId     String
  questionId String
  response   Json
  createdAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@map("onboarding_responses")
}

// ============================================================================
// Connected Social Accounts
// ============================================================================

model ConnectedAccount {
  id             String    @id @default(uuid())
  userId         String
  platform       Platform
  platformUserId String
  accessToken    String // Encrypted in application layer
  refreshToken   String? // Encrypted in application layer
  tokenExpiry    DateTime?
  permissions    Json?
  lastSynced     DateTime?
  createdAt      DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@map("connected_accounts")
}

// ============================================================================
// Protected Images
// ============================================================================

model ProtectedImage {
  id          String                      @id @default(uuid())
  userId      String
  storageUrl  String
  embedding   Unsupported("vector(512)")?
  hash        String? // Perceptual hash for quick comparison
  uploadedAt  DateTime                    @default(now())
  lastScanned DateTime?
  status      ImageStatus                 @default(ACTIVE)
  archivedAt  DateTime? // Timestamp when image was archived
  scanCount   Int                         @default(0) // Total number of scans performed
  matchCount  Int                         @default(0) // Total number of matches found

  // Face detection fields
  faceEmbedding  Unsupported("vector(512)")? // Face embedding vector for similarity search
  faceDetected   Boolean                     @default(false) // Whether a face was detected in the image
  faceConfidence Float?                      // Face detection confidence score (0.0-1.0)
  faceMetadata   Json?                       // Bounding box, landmarks, model info

  // Relations
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  matches  ImageMatch[]
  scanJobs ScanJob[]

  @@index([userId, status])
  @@index([userId, status, lastScanned])
  @@index([hash])
  @@index([userId, faceDetected]) // Index for filtering images with faces
  @@map("protected_images")
}

model ImageMatch {
  id               String           @id @default(uuid())
  protectedImageId String
  scanJobId        String? // Link to the scan job that discovered this match
  sourceUrl        String
  platform         String?
  similarity       Float
  matchType        ImageMatchType
  detectedAt       DateTime         @default(now())
  status           ImageMatchStatus @default(NEW)
  firstSeenAt      DateTime         @default(now()) // First time this match was detected
  lastSeenAt       DateTime         @default(now()) // Last time this match was confirmed

  // Confidence and verification fields
  confidence     String? // HIGH, MEDIUM_HIGH, MEDIUM, LOW - overall confidence tier
  clipSimilarity Float?  // CLIP cosine similarity score (0.0-1.0)
  faceVerified   String? // VERIFIED, NO_FACE_DETECTED, MISMATCH, null

  // Review workflow fields
  reviewStatus String    @default("ACTIVE") // ACTIVE, FLAGGED_FOR_REVIEW, CONFIRMED, DISMISSED
  reviewedAt   DateTime?
  reviewedBy   String? // userId who reviewed (UUID as string)

  // Person discovery fields
  discoveryEngine    String? // Which engine discovered this (e.g., 'google_lens', 'bing_reverse_image', 'tineye')
  candidateGroupId   String? // Groups results from a single person search (UUID)
  faceSimilarity     Float?  // Face similarity score if face verification was run (0-1)
  discoveryScore     Float?  // Raw discovery engine score (e.g., FaceCheck 0-100)
  verificationEngine String? // Which engine verified this match (e.g., 'tineye', 'deepface')
  parentCandidateId  String? // For TinEye expansion results, points to the PERSON_CANDIDATE they came from

  // Relations
  protectedImage  ProtectedImage @relation(fields: [protectedImageId], references: [id], onDelete: Cascade)
  scanJob         ScanJob?       @relation(fields: [scanJobId], references: [id], onDelete: SetNull)
  parentCandidate ImageMatch?    @relation("CandidateExpansion", fields: [parentCandidateId], references: [id])
  childMatches    ImageMatch[]   @relation("CandidateExpansion")

  @@unique([protectedImageId, sourceUrl])
  @@index([protectedImageId, status])
  @@index([scanJobId])
  @@index([reviewStatus])
  @@index([candidateGroupId])
  @@map("image_matches")
}

// ============================================================================
// Alerts
// ============================================================================

model Alert {
  id          String        @id @default(uuid())
  userId      String
  type        AlertType
  severity    AlertSeverity
  title       String
  description String
  metadata    Json?
  status      AlertStatus   @default(NEW)
  createdAt   DateTime      @default(now())
  viewedAt    DateTime?
  actionedAt  DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt])
  @@map("alerts")
}

// ============================================================================
// Protection Plan
// ============================================================================

model ProtectionPlan {
  id          String   @id @default(uuid())
  userId      String   @unique
  generatedAt DateTime @default(now())
  lastUpdated DateTime @default(now())

  // Relations
  user  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  items ProtectionPlanItem[]

  @@map("protection_plans")
}

model ProtectionPlanItem {
  id          String                   @id @default(uuid())
  planId      String
  category    String
  title       String
  description String
  priority    Int
  status      ProtectionPlanItemStatus @default(PENDING)
  dueDate     DateTime?
  createdAt   DateTime                 @default(now())

  // Relations
  plan ProtectionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, status])
  @@map("protection_plan_items")
}

// ============================================================================
// Scan Jobs
// ============================================================================

model ScanJob {
  id               String        @id @default(uuid())
  userId           String
  protectedImageId String? // Optional link to specific image being scanned
  type             ScanJobType
  status           ScanJobStatus @default(PENDING)
  priority         Int           @default(0) // Higher priority jobs run first
  progress         Int           @default(0) // Progress percentage (0-100)
  retryCount       Int           @default(0) // Number of retry attempts
  workerId         String? // ID of the worker processing this job
  startedAt        DateTime?
  completedAt      DateTime?
  result           Json?
  errorMessage     String?
  createdAt        DateTime      @default(now())

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  protectedImage ProtectedImage? @relation(fields: [protectedImageId], references: [id], onDelete: SetNull)
  imageMatches   ImageMatch[]

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status, priority, createdAt])
  @@index([protectedImageId])
  @@map("scan_jobs")
}

// ============================================================================
// Enums
// ============================================================================

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Platform {
  INSTAGRAM
  TIKTOK
  FACEBOOK
  TWITTER
  LINKEDIN
  YOUTUBE
  OTHER
}

enum AlertType {
  IMAGE_MISUSE
  FAKE_PROFILE
  DATA_BREACH
  SUSPICIOUS_FOLLOWER
  BEHAVIORAL_CHANGE
  DEEPFAKE_DETECTED
  PROFILE_IMPERSONATION
  FACE_MATCH // Face match found online - verified identity match
}

enum AlertSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  NEW
  VIEWED
  ACTIONED
  DISMISSED
}

enum ImageMatchType {
  EXACT
  SIMILAR
  MODIFIED
  DEEPFAKE
  PERSON_CANDIDATE // From SerpAPI discovery - visually similar person
  EXACT_COPY       // From TinEye - exact duplicate of a candidate
  ALTERED_COPY     // From TinEye - modified version of a candidate
  FACE_MATCH       // From FaceCheck.id - face recognition match
}

enum ImageMatchStatus {
  NEW
  REVIEWED
  ACTIONED
  DISMISSED
  FLAGGED_FOR_REVIEW
}

enum ImageStatus {
  ACTIVE
  ARCHIVED
}

enum ScanJobType {
  IMAGE_SCAN
  PROFILE_SCAN
  BREACH_CHECK
  BEHAVIORAL_ANALYSIS
  FULL_SCAN
}

enum ScanJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum ProtectionPlanItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}
